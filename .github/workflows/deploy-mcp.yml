name: Deploy Bob's MCP Server

# ========================================
# MCP SERVER DEPLOYMENT
# ========================================
# Builds and deploys Bob's MCP server to Cloud Run.
# This provides repository operations tools via Cloud API Registry.
#
# Trigger: Manual dispatch or on push to mcp/ directory
# Target: Cloud Run (bobs-brain-mcp-{env})
# Auth: Workload Identity Federation (R4 compliant)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      skip_tests:
        description: 'Skip MCP tests (USE ONLY FOR EMERGENCIES)'
        required: false
        default: false
        type: boolean
  push:
    branches: [main]
    paths:
      - 'mcp/**'
      - '.github/workflows/deploy-mcp.yml'

permissions:
  contents: read
  id-token: write  # Required for Workload Identity Federation (R4)

env:
  PYTHON_VERSION: '3.12'
  # Dynamic based on input or push
  DEPLOYMENT_ENV: ${{ github.event.inputs.environment || 'dev' }}

jobs:
  # Test MCP server
  test:
    name: Test MCP Server
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_tests != 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r mcp/requirements.txt
          pip install pytest pytest-asyncio

      - name: Run MCP tests
        working-directory: mcp
        run: |
          echo "Running MCP server tests..."
          pytest tests/ -v

      - name: Test Summary
        run: |
          echo "## MCP Tests Passed" >> $GITHUB_STEP_SUMMARY
          echo "All MCP server tests completed successfully." >> $GITHUB_STEP_SUMMARY

  # Build and push Docker image
  build:
    name: Build MCP Image
    runs-on: ubuntu-latest
    needs: [test]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
    outputs:
      image_tag: ${{ steps.build.outputs.image_tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to GCP (Workload Identity Federation)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCR
        run: |
          gcloud auth configure-docker gcr.io --quiet

      - name: Set environment variables
        id: vars
        run: |
          if [ "${{ env.DEPLOYMENT_ENV }}" == "prod" ]; then
            echo "PROJECT_ID=${{ vars.PROD_PROJECT_ID }}" >> $GITHUB_OUTPUT
          elif [ "${{ env.DEPLOYMENT_ENV }}" == "staging" ]; then
            echo "PROJECT_ID=${{ vars.STAGING_PROJECT_ID }}" >> $GITHUB_OUTPUT
          else
            echo "PROJECT_ID=${{ vars.DEV_PROJECT_ID }}" >> $GITHUB_OUTPUT
          fi
          echo "IMAGE_TAG=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        id: build
        working-directory: mcp
        run: |
          PROJECT_ID="${{ steps.vars.outputs.PROJECT_ID }}"
          IMAGE_TAG="${{ steps.vars.outputs.IMAGE_TAG }}"
          IMAGE_NAME="gcr.io/${PROJECT_ID}/bobs-mcp:${IMAGE_TAG}"

          echo "Building Docker image: ${IMAGE_NAME}"

          docker build -t "${IMAGE_NAME}" .
          docker push "${IMAGE_NAME}"

          # Also tag as latest for this environment
          LATEST_TAG="gcr.io/${PROJECT_ID}/bobs-mcp:${{ env.DEPLOYMENT_ENV }}-latest"
          docker tag "${IMAGE_NAME}" "${LATEST_TAG}"
          docker push "${LATEST_TAG}"

          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "image_name=${IMAGE_NAME}" >> $GITHUB_OUTPUT

      - name: Build Summary
        run: |
          echo "## Docker Image Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ steps.build.outputs.image_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ steps.build.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY

  # Deploy to Cloud Run
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: [test, build]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped') && needs.build.result == 'success'
    environment: ${{ github.event.inputs.environment || 'dev' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to GCP (Workload Identity Federation)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Set environment variables
        id: vars
        run: |
          ENV="${{ env.DEPLOYMENT_ENV }}"

          if [ "${ENV}" == "prod" ]; then
            echo "PROJECT_ID=${{ vars.PROD_PROJECT_ID }}" >> $GITHUB_OUTPUT
            echo "REGION=${{ vars.PROD_REGION }}" >> $GITHUB_OUTPUT
          elif [ "${ENV}" == "staging" ]; then
            echo "PROJECT_ID=${{ vars.STAGING_PROJECT_ID }}" >> $GITHUB_OUTPUT
            echo "REGION=${{ vars.STAGING_REGION }}" >> $GITHUB_OUTPUT
          else
            echo "PROJECT_ID=${{ vars.DEV_PROJECT_ID }}" >> $GITHUB_OUTPUT
            echo "REGION=${{ vars.DEV_REGION }}" >> $GITHUB_OUTPUT
          fi
          echo "SERVICE_NAME=bobs-brain-mcp-${ENV}" >> $GITHUB_OUTPUT

      - name: Deploy to Cloud Run
        run: |
          PROJECT_ID="${{ steps.vars.outputs.PROJECT_ID }}"
          REGION="${{ steps.vars.outputs.REGION }}"
          SERVICE_NAME="${{ steps.vars.outputs.SERVICE_NAME }}"
          IMAGE_TAG="${{ needs.build.outputs.image_tag }}"
          IMAGE="gcr.io/${PROJECT_ID}/bobs-mcp:${IMAGE_TAG}"

          echo "Deploying MCP server to Cloud Run..."
          echo "  Service: ${SERVICE_NAME}"
          echo "  Image: ${IMAGE}"
          echo "  Region: ${REGION}"

          gcloud run deploy "${SERVICE_NAME}" \
            --image="${IMAGE}" \
            --region="${REGION}" \
            --project="${PROJECT_ID}" \
            --platform=managed \
            --allow-unauthenticated=false \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=10 \
            --timeout=300 \
            --set-env-vars="PROJECT_ID=${PROJECT_ID},LOCATION=${REGION},ENVIRONMENT=${{ env.DEPLOYMENT_ENV }},APP_NAME=bobs-brain,APP_VERSION=${IMAGE_TAG}" \
            --quiet

      - name: Verify deployment
        run: |
          SERVICE_URL=$(gcloud run services describe "${{ steps.vars.outputs.SERVICE_NAME }}" \
            --region="${{ steps.vars.outputs.REGION }}" \
            --project="${{ steps.vars.outputs.PROJECT_ID }}" \
            --format='value(status.url)')

          echo "Service URL: ${SERVICE_URL}"

          # Test health endpoint (requires auth, so just check it exists)
          echo "MCP server deployed successfully!"
          echo "Note: Service requires authentication - test via API Registry"

      - name: Deployment Summary
        run: |
          echo "## MCP Server Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ env.DEPLOYMENT_ENV }}" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** ${{ steps.vars.outputs.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ steps.vars.outputs.REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Register MCP server in Cloud API Registry" >> $GITHUB_STEP_SUMMARY
          echo "2. Configure IAM for agent access" >> $GITHUB_STEP_SUMMARY
          echo "3. Test tool discovery via ApiRegistry.get_toolset()" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Console Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Cloud Run](https://console.cloud.google.com/run?project=${{ steps.vars.outputs.PROJECT_ID }})" >> $GITHUB_STEP_SUMMARY
          echo "- [API Registry](https://console.cloud.google.com/vertex-ai/agent-builder/api-registry?project=${{ steps.vars.outputs.PROJECT_ID }})" >> $GITHUB_STEP_SUMMARY
